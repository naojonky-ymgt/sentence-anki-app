<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Anki (En -> Jp File)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f0f2f5; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; padding: 20px; color: #333; }
        .card { background: white; width: 100%; max-width: 500px; padding: 40px 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
        .status { font-size: 14px; color: #888; margin-bottom: 20px; }
        .japanese { font-size: 24px; font-weight: bold; margin-bottom: 20px; line-height: 1.4; }
        .english { font-size: 20px; color: #007bff; margin-bottom: 30px; min-height: 30px; font-weight: 500; opacity: 0; transition: opacity 0.3s; }
        .english.visible { opacity: 1; }
        
        .unit-selector { margin-bottom: 20px; width: 100%; }
        select { width: 100%; padding: 12px; font-size: 16px; border-radius: 8px; border: 2px solid #ddd; background: #fff; cursor: pointer; font-weight: bold; }
        select:focus { border-color: #007bff; outline: none; }

        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        button { border: none; padding: 15px; border-radius: 12px; font-size: 16px; cursor: pointer; font-weight: bold; transition: background 0.2s; }
        
        .btn-mic-toggle { grid-column: span 2; background: #333; color: white; font-size: 18px; position: relative; overflow: hidden; }
        .btn-mic-toggle.active { background: #2ed573; }
        .mic-icon { margin-right: 8px; }
        .ripple { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 0; height: 0; background: rgba(255,255,255, 0.4); border-radius: 50%; pointer-events: none; }
        .btn-mic-toggle.active .ripple { animation: rippleEffect 2s infinite; }

        .btn-show { background: #f1f2f6; color: #333; }
        .btn-play { background: #f1f2f6; color: #333; }
        .btn-next { grid-column: span 2; background: #3742fa; color: white; margin-top: 10px; }

        .result-msg { margin-top: 15px; font-weight: bold; min-height: 24px; word-break: break-all; }
        .correct { color: #2ed573; }
        .close-call { color: #ffa502; }
        .incorrect { color: #ff4757; }
        .listening-text { font-size: 12px; color: #aaa; margin-top: 5px; min-height: 18px; }

        @keyframes rippleEffect { 0% { width: 0; height: 0; opacity: 1; } 100% { width: 400px; height: 400px; opacity: 0; } }
    </style>
</head>
<body>

<div class="card">
    <div class="unit-selector">
        <select id="unit-select" onchange="loadUnitFile(this.value)">
            <option value="" disabled selected>üìÇ ÂãâÂº∑„Åô„ÇãUnit„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ</option>
        </select>
    </div>

    <div class="status" id="counter">0 / 0</div>
    <div class="japanese" id="jp-text">Unit„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
    <div class="english" id="en-text">Please select a unit</div>
    
    <div class="result-msg" id="result-msg"></div>
    <div class="listening-text" id="listening-text">...</div>

    <div class="controls">
        <button class="btn-mic-toggle" id="btn-mic" onclick="toggleSession()">
            <span class="mic-icon">üé§</span><span id="mic-label">„Éû„Ç§„ÇØON„Å´„Åô„Çã (ÈñãÂßã)</span>
            <div class="ripple"></div>
        </button>
        <button class="btn-show" onclick="toggleAnswer()">Á≠î„Åà„ÇíË¶ã„Çã</button>
        <button class="btn-play" onclick="playAudio(true)">üîä „ÅäÊâãÊú¨</button>
        <button class="btn-next" onclick="nextCard()">Ê¨°„ÅÆ„Ç´„Éº„Éâ„Å∏ ‚û°</button>
    </div>
</div>

<script>
    // ==========================================
    // ‚ñº „Åì„Åì„Å´‰ΩøÁî®„Åô„Çã„Éï„Ç°„Ç§„É´Âêç„ÇíÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ
    // ==========================================
    const unitList = [
        { name: "Unit 7: ÂàÜË©û", file: "fb1_unit07.txt" },
        { name: "Unit 8: ÊØîËºÉ", file: "fb1_unit08.txt" },
        { name: "Unit 9: Èñ¢‰øÇË©û", file: "fb1_unit09.txt" }
    ];
    // ==========================================

    const PASS_THRESHOLD = 0.70; 

    let sentences = [];
    let currentIndex = 0;
    let recognition = null;
    let isSessionActive = false;
    let isSpeaking = false;

    const jpText = document.getElementById('jp-text');
    const enText = document.getElementById('en-text');
    const resultMsg = document.getElementById('result-msg');
    const listeningText = document.getElementById('listening-text');
    const btnMic = document.getElementById('btn-mic');
    const micLabel = document.getElementById('mic-label');
    const counter = document.getElementById('counter');
    const unitSelect = document.getElementById('unit-select');

    function init() {
        unitList.forEach(unit => {
            const option = document.createElement('option');
            option.value = unit.file;
            option.text = unit.name;
            unitSelect.appendChild(option);
        });

        setupRecognition();
        
        const lastUnit = localStorage.getItem('last_unit_file_v3');
        if(lastUnit && unitList.some(u => u.file === lastUnit)) {
            unitSelect.value = lastUnit;
            loadUnitFile(lastUnit);
        }
    }

    async function loadUnitFile(filename) {
        try {
            const response = await fetch(filename);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const text = await response.text();
            
            if(parseData(text)) {
                currentIndex = 0;
                showCard();
                localStorage.setItem('last_unit_file_v3', filename);
                resultMsg.innerText = "„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü (Ëã±Ë™û‚ÜíÊó•Êú¨Ë™ûÂΩ¢Âºè)";
                resultMsg.className = "result-msg";
            } else {
                alert("„Éá„Éº„ÇøÂΩ¢Âºè„Ç®„É©„Éº: Ëã±Ë™û[„Çø„Éñ]Êó•Êú¨Ë™û „ÅÆÂΩ¢Âºè„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
            }

        } catch (e) {
            console.error(e);
            alert("‚ö†Ô∏è Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº\n„Çµ„Éº„Éê„ÉºÁµåÁî±(GitHub PagesÁ≠â)„ÅßÈñã„ÅÑ„Å¶„ÅÑ„Åæ„Åô„ÅãÔºü\n„Éï„Ç°„Ç§„É´Âêç„ÅÆÂ§ßÊñáÂ≠óÂ∞èÊñáÂ≠ó„ÅØÂêà„Å£„Å¶„ÅÑ„Åæ„Åô„ÅãÔºü");
            jpText.innerText = "Error";
            enText.innerText = "Error";
        }
    }

    // ‚ñº‚ñº‚ñº „Åì„Åì„Çí‰øÆÊ≠£„Åó„Åæ„Åó„ÅüÔºàËã±Ë™û‚ÜíÊó•Êú¨Ë™û„ÅÆÈ†Ü„ÅßË™≠„ÅøÂèñ„ÇãÔºâ ‚ñº‚ñº‚ñº
    function parseData(text) {
        const lines = text.split('\n');
        const newSentences = [];
        lines.forEach(line => {
            if(!line.trim()) return;
            let parts = line.split('\t');
            if (parts.length < 2) parts = line.split('|');
            
            if(parts.length >= 2) {
                // ÈÖçÂàó„ÅÆ0Áï™ÁõÆ„Çí„ÄåËã±Ë™û(Ê≠£Ëß£)„Äç„ÄÅ1Áï™ÁõÆ„Çí„ÄåÊó•Êú¨Ë™û(ÂïèÈ°å)„Äç„Å®„Åó„Å¶Êâ±„ÅÑ„Åæ„Åô
                const en = parts[0].trim(); 
                const jp = parts[1].trim(); 
                if(jp && en) newSentences.push({ jp, en });
            }
        });
        if(newSentences.length > 0) {
            sentences = newSentences;
            return true;
        }
        return false;
    }
    // ‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤

    function setupRecognition() {
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) return;
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = 'en-US';
        recognition.continuous = true;
        recognition.interimResults = false;

        recognition.onresult = (event) => {
            if (!isSessionActive || isSpeaking) return;
            const lastResultIndex = event.results.length - 1;
            const transcript = event.results[lastResultIndex][0].transcript;
            listeningText.innerText = `ËÅû„ÅçÂèñ„Çä‰∏≠: "${transcript}"`;
            checkAnswer(transcript);
        };

        recognition.onerror = (event) => {
            if(event.error === 'not-allowed') {
                alert("„Éû„Ç§„ÇØË®±ÂèØ„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ");
                stopSession();
            }
        };
        recognition.onend = () => {
            if (isSessionActive) setTimeout(() => { try { recognition.start(); } catch(e){} }, 500);
        };
    }

    function toggleSession() {
        if (!recognition) { alert("„Éñ„É©„Ç¶„Ç∂ÈùûÂØæÂøú"); return; }
        if (isSessionActive) stopSession();
        else startSession();
    }

    function startSession() {
        try {
            recognition.start();
            isSessionActive = true;
            btnMic.classList.add('active');
            micLabel.innerText = "„Éû„Ç§„ÇØON‰∏≠";
            resultMsg.innerText = "üé§ „ÅäË©±„Åó„Åè„Å†„Åï„ÅÑ...";
        } catch(e) {}
    }

    function stopSession() {
        isSessionActive = false;
        recognition.stop();
        btnMic.classList.remove('active');
        micLabel.innerText = "„Éû„Ç§„ÇØON„Å´„Åô„Çã (ÈñãÂßã)";
    }

    function showCard() {
        if(sentences.length === 0) return;
        const item = sentences[currentIndex];
        jpText.innerText = item.jp;
        enText.innerText = item.en;
        enText.classList.remove('visible');
        resultMsg.innerText = isSessionActive ? "üé§ „ÅäË©±„Åó„Åè„Å†„Åï„ÅÑ..." : "";
        resultMsg.className = "result-msg";
        listeningText.innerText = "...";
        counter.innerText = `${currentIndex + 1} / ${sentences.length}`;
    }

    function nextCard() {
        currentIndex = (currentIndex + 1) % sentences.length;
        showCard();
    }

    function toggleAnswer() {
        enText.classList.toggle('visible');
    }

    function playAudio(force = false) {
        if(sentences.length === 0) return;
        isSpeaking = true; 
        const u = new SpeechSynthesisUtterance(sentences[currentIndex].en);
        u.lang = 'en-US';
        u.onend = () => {
            isSpeaking = false;
            if(!force) setTimeout(nextCard, 1500); 
        };
        speechSynthesis.speak(u);
    }

    function checkAnswer(spokenText) {
        const correctText = sentences[currentIndex].en;
        const normalize = (str) => str.toLowerCase().replace(/[^a-z0-9\s]/g, '').trim();
        const spokenClean = normalize(spokenText);
        const correctClean = normalize(correctText);
        const similarity = getSimilarity(spokenClean, correctClean);
        const similarityPercent = Math.round(similarity * 100);

        if (similarity >= PASS_THRESHOLD) {
            if (similarity === 1.0) {
                resultMsg.innerText = `‚≠ï Perfect! (${similarityPercent}%)`;
                resultMsg.className = "result-msg correct";
            } else {
                resultMsg.innerText = `üÜó Good! (${similarityPercent}%) - You said: "${spokenText}"`;
                resultMsg.className = "result-msg close-call";
            }
            enText.classList.add('visible');
            playAudio(false); 
        } else {
            resultMsg.innerText = `‚ùå Match: ${similarityPercent}% ... You said: "${spokenText}"`;
            resultMsg.className = "result-msg incorrect";
        }
    }

    function getSimilarity(s1, s2) {
        let longer = s1; let shorter = s2;
        if (s1.length < s2.length) { longer = s2; shorter = s1; }
        const longerLength = longer.length;
        if (longerLength === 0) return 1.0;
        return (longerLength - editDistance(longer, shorter)) / parseFloat(longerLength);
    }

    function editDistance(s1, s2) {
        s1 = s1.toLowerCase(); s2 = s2.toLowerCase();
        const costs = new Array();
        for (let i = 0; i <= s1.length; i++) {
            let lastValue = i;
            for (let j = 0; j <= s2.length; j++) {
                if (i === 0) costs[j] = j;
                else {
                    if (j > 0) {
                        let newValue = costs[j - 1];
                        if (s1.charAt(i - 1) !== s2.charAt(j - 1)) newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                        costs[j - 1] = lastValue;
                        lastValue = newValue;
                    }
                }
            }
            if (i > 0) costs[s2.length] = lastValue;
        }
        return costs[s2.length];
    }

    init();
</script>

</body>
</html>
